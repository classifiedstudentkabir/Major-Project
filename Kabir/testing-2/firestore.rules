rules_version = '2';

service cloud.firestore {
  function isValidLead() {
    return request.resource.data.keys().hasOnly([
      'name',
      'email',
      'phone',
      'service',
      'siteLocation',
      'budget',
      'message',
      'createdAt'
    ])
    && request.resource.data.keys().hasAll([
      'name',
      'phone',
      'service',
      'message',
      'createdAt'
    ])
    && request.resource.data.name is string
    && request.resource.data.name.size() <= 80
    && request.resource.data.phone is string
    && request.resource.data.phone.size() <= 30
    && request.resource.data.service is string
    && request.resource.data.service.size() <= 60
    && request.resource.data.message is string
    && request.resource.data.message.size() <= 1000
    && request.resource.data.createdAt is timestamp
    && request.resource.data.createdAt == request.time
    && isOptionalString('email', 120)
    && isOptionalString('siteLocation', 120)
    && isOptionalString('budget', 30)
    && isOptionalEmail();
  }

  function isOptionalString(field, maxLen) {
    return !(field in request.resource.data)
      || (request.resource.data[field] is string
        && request.resource.data[field].size() <= maxLen);
  }

  function isOptionalEmail() {
    return !('email' in request.resource.data)
      || (request.resource.data.email is string
        && request.resource.data.email.size() <= 120
        && request.resource.data.email.matches('.*@.*\\..*'));
  }

  match /databases/{database}/documents {
    match /leads/{docId} {
      allow create: if isValidLead();
      allow read, update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
