rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null 
        && request.auth.token.email == 'krishnaenterprises1001@gmail.com';
    }
    
    // Helper function to validate lead data
    function isValidLead(lead) {
      return lead.keys().hasAll(['name', 'email', 'phone', 'service', 'siteLocation', 'message'])
        && lead.name is string && lead.name.size() > 0 && lead.name.size() <= 100
        && lead.email is string && lead.email.matches('^[^@]+@[^@]+\\.[^@]+$')
        && lead.phone is string && lead.phone.size() >= 10 && lead.phone.size() <= 15
        && lead.service is string && lead.service.size() > 0
        && lead.siteLocation is string && lead.siteLocation.size() > 0
        && lead.message is string && lead.message.size() > 0 && lead.message.size() <= 1000;
    }
    
    // Leads collection
    match /leads/{leadId} {
      // Public can only CREATE new leads with validation
      allow create: if isValidLead(request.resource.data)
                    && request.resource.data.keys().hasOnly(['name', 'email', 'phone', 'service', 'siteLocation', 'budget', 'message', 'createdAt'])
                    && request.resource.data.createdAt == request.time;
      
      // Only admin can read, update, and delete leads
      allow read: if isAdmin();
      
      allow update: if isAdmin()
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['status', 'updatedAt']);
      
      allow delete: if isAdmin();
    }
    
    // Settings collection (for maintenance mode and form lock)
    match /settings/{settingId} {
      // Only admin can read and write settings
      allow read, write: if isAdmin();
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
